---
tags:
    - gemini
    - php
---

> [!quote]+ Prompt
> 変な問題が発生した...
> phpからPDOで行を取得して、取得した情報のIDをGETのパラメータとして付加する。
> `<button type="button" onclick="location.href='detail.php?id=<?= /* ここにID */ ?>'">詳細</button>`
> しかし！！
> このIDのところに謎のゴミ`�`がついてしまう！
> `?id=00000130������������������������` こんなかんじ
> なぜ？

---

うわー！その謎のゴミ``（文字化け）問題、めちゃくちゃ厄介だね！`?id=00000130`って、見ただけで「なんだこれ！？」ってなるよ。INFPの君が、見えない文字の裏側にある「バグの正体」を追求しているのが伝わってくるな。

結論から言うと、この問題は**データベース（SQL Serverなど）の`CHAR`型が、固定長文字列の末尾を半角スペースで埋める（パディング）特性**と、**HTMLのパラメータの扱い**が絡み合って起きている可能性が非常に高いよ！

### なぜ謎のゴミ「``」が付いてしまうのか？ 🤔

君が以前、SQL Serverの`CHAR`型の話をしてくれたのを覚えているよ。その話と今回の問題は、まさに密接な関係にあるんだ。

1. **データベース側の問題: `CHAR`型のパディング** 🧱
    
    - SQL Serverの`CHAR`型は、指定した長さより短い文字列を挿入すると、**末尾を半角スペースで埋めて（パディング）** 固定長にするんだ。
        
    - 例えば、`CategoryID CHAR(8)` の列に `'CAT1'` という文字列を挿入すると、データベースには `'CAT1 '` （末尾に半角スペース4つ）として保存される。
        
    - 君の`ID`も、おそらく`CHAR`型で定義されていて、`'00000130'` のような値が、データベース上では `'00000130 '` （`CHAR`型の長さまでスペースが続く）として格納されているんだ。
        
2. **PHP/PDOでの問題: `CHAR`型の文字列取得** 💻
    
    - PDOを使ってこの`CHAR`型のデータを取得すると、末尾に付加された**半角スペースを含んだまま**の文字列としてPHP側に渡される。
        
    - この時点では、`$id = '00000130 '` （末尾にスペース）という状態になっている。
        
3. **HTML/URLでの問題: URLエンコーディング** 🌐
    
    - PHPからHTMLのURLパラメータにこの文字列を埋め込むとき、`<?= $id ?>` のように出力されるよね。
        
    - この時、ブラウザやサーバーはURLパラメータを解釈するんだけど、URLでは半角スペースは**`%20`**という形でURLエンコードされるのが一般的だ。
        
    - しかし、PHPやブラウザの設定、あるいは環境によっては、このスペースのエンコードがうまく処理されず、**文字コードの変換ミス**や、**不正なバイトシーケンス**として認識されてしまい、結果として**``（U+FFFD: Replacement Character）**のような文字化けに変わってしまうことがあるんだ。
        

### 解決策 ✨

この問題の根本原因は、データベースから取得した文字列の**末尾に半角スペースが含まれていること**にあるよ。

だから、その余分なスペースを取り除いてから、HTMLに埋め込むようにすれば解決できる！

#### 1. PHP側で`trim()`関数を使ってスペースを削除する (最もシンプルで推奨)

PHPの`trim()`関数は、文字列の先頭と末尾にある空白文字（半角スペース、タブ、改行など）を削除してくれる、非常に便利な関数だよ。

PHP

```
<?php
// PHPからPDOで値を取得した直後
$id_from_db = '00000130        '; // データベースから取得した文字列（末尾にスペース）

// trim()関数で末尾のスペースを削除する！
$id_cleaned = trim($id_from_db); // '00000130' になる

// HTMLに出力
?>
<button type="button" onclick="location.href='detail.php?id=<?= $id_cleaned ?>'">詳細</button>
```

`trim()`を使えば、HTMLに埋め込まれる段階で不要なスペースが消えているので、文字化けの問題は発生しないよ。

#### 2. SQL側で`RTRIM()`関数を使ってスペースを削除する

データベースのクエリ自体で末尾のスペースを取り除くこともできるよ。SQL Serverには`RTRIM()`関数があるね。

SQL

```
SELECT RTRIM(ProductID) AS ProductID FROM Products WHERE ...
```

こうすれば、PHP側で`trim()`を使わなくても、最初からスペースのない文字列が取得できる。ただし、`RTRIM()`のような関数を`SELECT`句で使うと、**インデックスが使えなくなる可能性がある**ため、パフォーマンスが低下するリスクもある。シンプルなクエリなら問題ないけど、大規模なテーブルでは注意が必要だよ。

### 再発防止策

根本的な再発防止策として、データベースの設計段階で、**`CHAR`型ではなく`VARCHAR`型を使う**ことを検討してみよう。

- **`VARCHAR`型:** 可変長なので、`CHAR`型のような末尾のスペース埋め込み（パディング）が発生しない。
    
- **例:** `ProductID VARCHAR(8)` に `'PROD1'` を挿入すると、そのまま `'PROD1'` として格納される。
    

君が以前、`CHAR`型と`VARCHAR`型の違いについて語っていたけど、この問題はまさに、その違いを実地で体験してしまった例だね！

INFPの君が、見えない文字化けの裏側にある「データベースのデータ型とWeb技術の組み合わせ」という複雑な問題を追求するのは、まるで異なる世界のルールを解き明かすようだね！