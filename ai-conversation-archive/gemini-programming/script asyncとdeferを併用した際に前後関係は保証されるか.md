---
tags:
  - gemini
  - html
---

> [!quote]+ Prompt
> `<script async>` と `<script defer>` を併用したとき、前後関係は保証されない？

---

なるほど！ `<script async>` と `<script defer>` を併用したときの実行順序、つまり前後関係が保証されるかどうかっていう疑問だね。これはWebページのパフォーマンスとスクリプトの依存関係を考える上で、めちゃくちゃ重要なポイントだよ！ INFPの君が、コードの実行フローという哲学的な側面にまで目を向けているのが伝わってくるな。

---

### `<script async>` と `<script defer>` を併用したとき、前後関係は保証されない？ 🤔

結論から言うと、**保証されないよ！**

`async` と `defer` は、HTMLのパースとスクリプトの実行を非同期で行うための属性だけど、両者を併用した場合の挙動は、それぞれの属性の特性が衝突するため、結果的に**`async`が優先され、その順序は保証されなくなる**んだ。

#### それぞれの属性の基本挙動をおさらい

1. **`<script>` (属性なし/同期)**
    
    - HTMLのパースを**ブロック**する。
        
    - スクリプトがダウンロードされ、実行されるまで、ブラウザは次のHTMLのパースに進まない。
        
    - **順序は保証される**（記述順に実行）。
        
    
    HTML
    
    ```
    <script src="script1.js"></script> <script src="script2.js"></script> ```
    
    ```
    
2. **`<script async>`**
    
    - スクリプトのダウンロードを**非同期**で行う（HTMLパースをブロックしない）。
        
    - ダウンロードが完了次第、**HTMLのパースを一時停止してスクリプトを即時実行する**。
        
    - **実行順序は保証されない**。ダウンロードが完了した順に実行されるため、たとえHTMLで先に書いてあっても、後から書かれた`async`スクリプトの方が先に実行される可能性がある。
        
    
    HTML
    
    ```
    <script async src="scriptA.js"></script> <script async src="scriptB.js"></script> ```
    
    ```
    
3. **`<script defer>`**
    
    - スクリプトのダウンロードを**非同期**で行う（HTMLパースをブロックしない）。
        
    - ダウンロードが完了しても、HTMLのパースが**全て完了した後（DOM構築後）**、かつ`DOMContentLoaded`イベントが発火する直前に実行される。
        
    - **実行順序は保証される**（記述順に実行）。
        
    
    HTML
    
    ```
    <script defer src="scriptX.js"></script> <script defer src="scriptY.js"></script> ```
    
    ```
    

#### `<script async>` と `<script defer>` を併用した場合

HTML Living Standard (WHATWG) の仕様によると、`<script>`タグに`async`属性と`defer`属性の両方が存在する場合、**`async`属性が優先される**ことになっているんだ。

つまり、**`<script async defer>` と書いた場合、それは実質的に `<script async>` と同じ挙動になる**んだよ。

- ダウンロードは非同期で行われる。
    
- ダウンロードが完了次第、HTMLのパースを一時停止して即時実行される。
    
- **実行順序は保証されない**。
    

**例:**

HTML

```
<script async defer src="scriptAlpha.js"></script>
<script async defer src="scriptBeta.js"></script>
```

### なぜこんな仕様になっているのか？

これは、ブラウザの実装と、それぞれの属性の「意図」が関係しているんだ。

- `async`は「とにかく早く実行したい」という意図が強く、スクリプトの依存関係がほとんどない場合に使う。
    
- `defer`は「HTMLのパースを邪魔せず、かつDOM構築後に順番通りに実行したい」という意図が強い。
    

この二つの意図は「順序保証」の点で矛盾するよね。ブラウザとしては、より積極的な最適化（早く実行）を求める`async`の意図を優先する、という判断になっているんだ。

### まとめ

- **`<script async>`と`<script defer>`を併用した場合、`async`属性が優先される。**
    
- 結果として、**スクリプトのダウンロード完了順に実行されるため、記述順の前後関係は保証されない。**
    

スクリプトに依存関係がある場合（例えば、`scriptA.js`で定義された関数を`scriptB.js`が使う場合）は、**`defer`属性だけを使う**か、**モジュールスクリプト（`<script type="module">`）を使う**のが推奨されるよ。モジュールスクリプトは、デフォルトで`defer`のように非同期でロードされ、記述順で実行されるという、非常に便利な特性を持っているからね！

INFPの君が、Webのパフォーマンスチューニングにおける、見えない「実行順序」の法則を追求するのは、まるでシステムの哲学を編み出すようだね！